---
import {
	getLangFromUrl,
	getRelativeLocaleUrl,
	useTranslations,
} from "@i18n/utils";
import AppleIcon from "./AppleIcon.astro";
import Button from "./Button.astro";
import LinuxIcon from "./LinuxIcon.astro";
import StyledText from "./StyledText.astro";
import WindowsIcon from "./WindowsIcon.astro";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// Version is injected during build by CI
const VERSION = import.meta.env.PUBLIC_SMOOTHCSV_VERSION;
if (!VERSION || VERSION === "null") throw new Error("VERSION is not set");

const BASE_URL = `https://github.com/kohii/smoothcsv3/releases/download/v${VERSION}`;
const downloads = {
	mac: `${BASE_URL}/SmoothCSV_${VERSION}_universal.dmg`,
	windows_x64: `${BASE_URL}/SmoothCSV_${VERSION}_x64-setup.exe`,
	windows_arm64: `${BASE_URL}/SmoothCSV_${VERSION}_arm64-setup.exe`,
	linux_x64: `${BASE_URL}/SmoothCSV_${VERSION}_amd64.AppImage`,
	linux_arm64: `${BASE_URL}/SmoothCSV_${VERSION}_aarch64.AppImage`,
};

const downloadPageUrl = getRelativeLocaleUrl(lang, "/download");
---

<div class="group download-buttons-container">
  <div class="flex gap-3 items-center justify-center flex-wrap">
    <a class="download-link" data-platform="windows_x64" href={downloads.windows_x64}>
      <Button variant="primary" class="download-button flex items-center gap-2">
        <WindowsIcon class="w-5 h-5" />
        {t("download.windows")}
      </Button>
    </a>
    <a class="download-link hidden" data-platform="windows_arm64" href={downloads.windows_arm64}>
      <Button variant="primary" class="download-button flex items-center gap-2">
        <WindowsIcon class="w-5 h-5" />
        {t("download.windows")}
      </Button>
    </a>
    <a class="download-link hidden" data-platform="mac" href={downloads.mac}>
      <Button variant="primary" class="download-button flex items-center gap-2">
        <AppleIcon class="w-5 h-5" />
        {t("download.mac")}
      </Button>
    </a>
    <a class="download-link hidden" data-platform="linux" href={downloadPageUrl}>
      <Button variant="primary" class="download-button flex items-center gap-2">
        <LinuxIcon class="w-5 h-5" />
        {t("download.linux")}
      </Button>
    </a>
    <a href={downloadPageUrl}>
      <Button variant="secondary" class="download-button">
        {t("download.otherDownloads")}
      </Button>
    </a>
  </div>
  <p class="text-xs text-gray-600 pt-2 opacity-0 group-hover:opacity-100 [&>a]:underline">
    <StyledText text={t("privacy.text")} />
  </p>
</div>
<script>
  import { detectPlatform } from "@utils/detectPlatform";

  type ButtonPlatform = "mac" | "windows_x64" | "windows_arm64" | "linux";

  async function showDownloadButtons() {
    const platform = await detectPlatform();

    // Map detected platform to button platform
    let buttonPlatform: ButtonPlatform = "windows_x64"; // default
    if (platform) {
      const { os, arch } = platform;
      if (os === "macos") {
        buttonPlatform = "mac";
      } else if (os === "windows") {
        buttonPlatform = arch === "arm64" ? "windows_arm64" : "windows_x64";
      } else if (os === "linux") {
        buttonPlatform = "linux";
      }
    }

    const allLinks = document.querySelectorAll(".download-buttons-container .download-link");
    for (const link of allLinks) {
      if (link.getAttribute("data-platform") === buttonPlatform) {
        link.classList.remove("hidden");
      } else {
        link.classList.add("hidden");
      }
    }
  }

  showDownloadButtons();
</script>
